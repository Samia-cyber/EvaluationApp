@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using WebApplication1.Data

@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
        @inject ApplicationDbContext Context
        @inject Microsoft.AspNetCore.Http.IHttpContextAccessor ContextAccessor


        @{
var totalCandidats = Context.Candidats.Count();
var totalCandidatures = Context.Candidatures.Count(c => c.Statut == "En attente");
var totalEvaluations = Context.Evaluations.Count();
var totalEntretiens = Context.Entretiens.Count(e => e.Statut == "Programm√©");
        }

        @{
string displayName = "Utilisateur";

if (SignInManager.IsSignedIn(User))
{
    var userId = UserManager.GetUserId(User);
    var candidat = await Context.Candidats.FirstOrDefaultAsync(c => c.UserId == userId);

    if (candidat != null)
    {
        displayName = $"{candidat.Prenom} {candidat.Nom}";
    }
    else
    {
        var user = await UserManager.GetUserAsync(User);
        displayName = user?.Email ?? "Utilisateur";
    }
}
        }

        <!DOCTYPE html>
        <html lang="fr">
        <head>
            <meta charset="utf-8" />
            <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>@ViewData["Title"] - HireDesk</title>

            <!-- Google Fonts -->
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

            <!-- Bootstrap -->
            <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />

            <!-- Dashboard CSS -->
            <link rel="stylesheet" href="~/css/dashboard-hiredesk.css" asp-append-version="true" />

            <style>
                /* Fix emoji rendering */
                .brand-icon, .nav-icon, .search-icon {
                    font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', sans-serif;
                }

                /* Fix logout button */
                .logout-btn {
                    background: none;
                    border: none;
                    width: 100%;
                    cursor: pointer;
                    padding: 0;
                    font-family: inherit;
                    text-align: left;
                }

                    .logout-btn:hover {
                        background: rgba(255,255,255,0.1) !important;
                    }
            </style>
        </head>

        <body class="dashboard-body">
            <div class="dashboard-layout">

                <!-- SIDEBAR -->
                <aside class="dashboard-sidebar">
                    <div class="sidebar-brand">
                        <div class="brand-icon">üìã</div>
                        <span class="brand-text">HireDesk</span>
                        <button class="sidebar-toggle">‚óÄ</button>
                    </div>

                    <nav class="sidebar-nav">
                        <a href="@Url.Action("Index", "Dashboard")" class="nav-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "Dashboard" ? "active" : "")">
                            <span class="nav-icon">üìä</span>
                            <span class="nav-text">Tableau de bord</span>
                        </a>

                        <a href="@Url.Action("Index", "Candidatures")" class="nav-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "Candidatures" ? "active" : "")">
                            <span class="nav-icon">üìã</span>
                            <span class="nav-text">Candidatures</span>
                            @if (totalCandidatures > 0)
                    {
                            <span class="nav-badge">@totalCandidatures</span>
                    }
                        </a>

                        <a href="@Url.Action("Index", "Candidats")" class="nav-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "Candidats" ? "active" : "")">
                            <span class="nav-icon">üë•</span>
                            <span class="nav-text">Candidats</span>
                            <span class="nav-badge">@totalCandidats</span>
                        </a>

                        <a href="@Url.Action("Index", "Evaluations")" class="nav-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "Evaluations" ? "active" : "")">
                            <span class="nav-icon">üìù</span>
                            <span class="nav-text">√âvaluations</span>
                            @if (totalEvaluations > 0)
                    {
                            <span class="nav-badge">@totalEvaluations</span>
                    }
                        </a>

                        <a href="@Url.Action("Index", "Entretiens")" class="nav-link">
                            <span class="nav-icon">üìÖ</span>
                            <span class="nav-text">Entretiens</span>
                            @if (totalEntretiens > 0)
                    {
                            <span class="nav-badge">@totalEntretiens</span>
                    }
                        </a>

                        <a href="@Url.Action("Index", "Statistiques")" class="nav-link">
                            <span class="nav-icon">üìä</span>
                            <span class="nav-text">Statistiques</span>
                        </a>
                    </nav>

                    <div class="sidebar-footer">
                        <form asp-area="Identity"
                              asp-page="/Account/Logout"
                              asp-route-returnUrl="/"
                              method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="nav-link logout-btn" style="color: white;">
                                <span class="nav-icon">üö™</span>
                                <span class="nav-text">D√©connexion</span>
                            </button>
                        </form>
                    </div>


                </aside>

                <!-- MAIN -->
                <div class="dashboard-main">

                    <!-- TOPBAR -->
                    <header class="dashboard-topbar">
                        <div class="topbar-left">
                            <!-- Recherche supprim√©e -->
                        </div>

                        <div class="topbar-right">
                            <a href="@Url.Action("Create", "Candidats")" class="btn-add-candidate">
                                <span>+</span>
                                <span>Ajouter un candidat</span>
                            </a>

                            @if (SignInManager.IsSignedIn(User))
                    {
                            <div style="display:flex; align-items:center; gap:10px; margin-left:15px;">
                                <div style="
                                width:36px;
                                height:36px;
                                border-radius:50%;
                                background:#10b981;
                                color:white;
                                display:flex;
                                align-items:center;
                                justify-content:center;
                                font-weight:600;">
                                    @displayName.Substring(0,1).ToUpper()
                                </div>

                                <div style="display:flex; flex-direction:column; line-height:1;">
                                    <span style="font-weight:600; color:#111;">
                                        @displayName
                                    </span>
                                    <small style="color:#6b7280;">
                                        Administrateur
                                    </small>
                                </div>
                            </div>
                    }

                        </div>
                    </header>

                    <!-- CONTENU -->
                    <main class="dashboard-content">
                        @RenderBody()
                    </main>

                </div>
            </div>

            <script src="~/lib/jquery/dist/jquery.min.js"></script>
            <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
            <script src="~/js/site.js" asp-append-version="true"></script>

            @await RenderSectionAsync("Scripts", required: false)
        </body>
    </html>
